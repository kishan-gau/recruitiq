services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: recruitiq_postgres_dev
    restart: unless-stopped
    command: ["postgres", "-c", "listen_addresses=*"]
    env_file:
      - .env.development
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      # Tenant creation parameters from .env file
      DEFAULT_LICENSE_ID: ${DEFAULT_LICENSE_ID}
      DEFAULT_CUSTOMER_ID: ${DEFAULT_CUSTOMER_ID}
      DEFAULT_CUSTOMER_EMAIL: ${DEFAULT_CUSTOMER_EMAIL}
      DEFAULT_CUSTOMER_NAME: ${DEFAULT_CUSTOMER_NAME}
      # Map .env variables to script variable names
      DEFAULT_TENANT_NAME: ${DEFAULT_CUSTOMER_NAME}
      DEFAULT_TENANT_EMAIL: ${DEFAULT_CUSTOMER_EMAIL}
    ports:
      - "5432:5432"
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
      # Mount initialization script and dependencies
      - ./backend/docker-init/docker-entrypoint-init.sh:/docker-entrypoint-initdb.d/01-init-database.sh:ro
      - ./backend:/backend:ro
    networks:
      - recruitiq_dev_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: recruitiq_redis_dev
    restart: unless-stopped
    ports:
      - "6379:6379"
    env_file:
      - ./backend/.env
    command: >
      sh -c '
      redis-server 
      --requirepass "$$REDIS_PASSWORD"
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      '
    volumes:
      - redis_dev_data:/data
    networks:
      - recruitiq_dev_network
    healthcheck:
      test: ["CMD", "sh", "-c", "redis-cli --no-auth-warning -a \"$$REDIS_PASSWORD\" ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Backend API (Development)
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
      target: development
    container_name: recruitiq_backend_dev
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file:
      - ./backend/.env
    environment:
      NODE_ENV: development
      PORT: 3001
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-recruitiq_dev}
      SESSION_SECRET: ${SESSION_SECRET:-dev-session-secret-change-in-production}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:5177}
    ports:
      - "3001:3001"
    volumes:
      # Mount source code for hot-reload (paths match Dockerfile structure: /app/backend/)
      - ./backend/src:/app/backend/src:ro
      - ./backend/scripts:/app/backend/scripts:ro
      - ./backend/package.json:/app/backend/package.json:ro
      - ./backend/knexfile.js:/app/backend/knexfile.js:ro
      - ./backend/migrations:/app/backend/migrations:ro
      - ./backend/seeds:/app/backend/seeds:ro
      # Mount apps directory for frontend validation
      - ./apps:/app/apps:ro
      # Named volumes for logs and uploads
      - backend_dev_logs:/app/backend/logs
      - backend_dev_uploads:/app/backend/uploads
      # NOTE: node_modules volumes REMOVED - use the dependencies installed in Docker image
      # Adding node_modules volumes would create EMPTY directories that override the built-in dependencies
    networks:
      - recruitiq_dev_network

  # Deployment Service
  # deployment-service:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.deployment-service
  #     target: development
  #   container_name: recruitiq_deployment_service_dev
  #   restart: unless-stopped
  #   depends_on:
  #     - postgres
  #     - redis
  #   environment:
  #     NODE_ENV: development
  #     PORT: 3002
  #     DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-recruitiq_dev}
  #     REDIS_HOST: redis
  #     REDIS_PORT: 6379
  #     REDIS_PASSWORD: ${REDIS_PASSWORD:-redis123}
  #     JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-key-change-in-production}
  #   ports:
  #     - "3002:3002"
  #   volumes:
  #     - ./deployment-service/src:/app/src:ro
  #     - ./deployment-service/package.json:/app/package.json:ro
  #     - /app/node_modules
  #   networks:
  #     - recruitiq_dev_network
  #   command: ["npm", "run", "dev"]

  # Legacy Frontend Applications (DEPRECATED - Use unified 'web' app below)
  # Individual apps are maintained for backward compatibility and migration testing only
  # 
  # Note: Legacy apps (nexus, paylinq, portal, recruitiq) have been removed.
  # Use the unified web app (apps/web) for all development.

  # Web Frontend (Unified - Development)
  web:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      target: development
      args:
        APP_NAME: web
    container_name: recruitiq_web_dev
    restart: unless-stopped
    ports:
      - "5177:5177"
    volumes:
      - ./apps/web:/app/apps/web
      - ./packages:/app/packages:ro
      - ./package.json:/app/package.json:ro
      - ./pnpm-lock.yaml:/app/pnpm-lock.yaml:ro
      - ./pnpm-workspace.yaml:/app/pnpm-workspace.yaml:ro
      - /app/node_modules
      - /app/apps/web/node_modules
    networks:
      - recruitiq_dev_network
    environment:
      - VITE_API_URL=http://localhost:3001
      - VITE_APP_ENV=development
    command: ["pnpm", "dev", "--host", "0.0.0.0", "--port", "5177"]

volumes:
  postgres_dev_data:
    driver: local
  redis_dev_data:
    driver: local
  backend_dev_logs:
    driver: local
  backend_dev_uploads:
    driver: local

networks:
  recruitiq_dev_network:
    driver: bridge