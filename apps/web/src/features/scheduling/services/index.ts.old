/**
 * ScheduleHub Services
 * 
 * Service layer wrappers for ScheduleHubClient from @recruitiq/api-client
 * Provides clean TypeScript interfaces for all scheduling operations
 */

import { ScheduleHubClient, APIClient } from '@recruitiq/api-client';
import type {
  Schedule,
  ScheduleWithShifts,
  CreateScheduleForm,
  Shift,
  CreateShiftForm,
  Worker,
  WorkerWithRoles,
  CreateWorkerForm,
  Station,
  CreateStationForm,
  Role,
  CreateRoleForm,
  Availability,
  CreateAvailabilityForm,
  TimeOffRequest,
  CreateTimeOffRequestForm,
  ShiftSwapOffer,
  CreateSwapOfferForm,
  ShiftTemplate,
  ShiftTemplateDetails,
  CreateShiftTemplateRequest,
  UpdateShiftTemplateRequest,
  DashboardStats,
} from '../types';

// Singleton instances
const apiClient = new APIClient();
const schedulehubClient = new ScheduleHubClient(apiClient);

// =============================================================================
// SCHEDULES SERVICE
// =============================================================================

export const schedulesService = {
  /**
   * Lists all schedules with optional filters
   */
  async listSchedules(filters?: {
    status?: 'draft' | 'published' | 'archived';
    department_id?: string;
    location_id?: string;
    start_date?: string;
    end_date?: string;
  }) {
    const response = await schedulehubClient.listSchedules(filters);
    return response.data.schedules || response.data;
  },

  /**
   * Gets a single schedule by ID
   */
  async getSchedule(id: string) {
    const response = await schedulehubClient.getSchedule(id);
    return response.data.schedule || response.data;
  },

  /**
   * Gets a schedule with all its shifts
   */
  async getScheduleWithShifts(id: string): Promise<ScheduleWithShifts> {
    const response = await schedulehubClient.getScheduleWithShifts(id);
    return response.data.schedule || response.data;
  },

  /**
   * Creates a new schedule
   */
  async createSchedule(data: CreateScheduleForm) {
    const response = await schedulehubClient.createSchedule(data);
    return response.data.schedule || response.data;
  },

  /**
   * Updates an existing schedule
   */
  async updateSchedule(id: string, updates: Partial<CreateScheduleForm>) {
    const response = await schedulehubClient.updateSchedule(id, updates);
    return response.data.schedule || response.data;
  },

  /**
   * Deletes a schedule (soft delete)
   */
  async deleteSchedule(id: string) {
    await schedulehubClient.deleteSchedule(id);
  },

  /**
   * Publishes a schedule
   */
  async publishSchedule(id: string) {
    const response = await schedulehubClient.publishSchedule(id);
    return response.data;
  },

  /**
   * Auto-generates a schedule using templates
   */
  async generateSchedule(data: {
    name: string;
    start_date: string;
    end_date: string;
    template_ids: string[];
    department_id?: string;
    location_id?: string;
  }) {
    const response = await schedulehubClient.generateSchedule(data);
    return response.data.schedule || response.data;
  },

  /**
   * Regenerates shifts for an existing schedule
   */
  async regenerateSchedule(id: string, templateIds: string[]) {
    const response = await schedulehubClient.regenerateSchedule(id, { template_ids: templateIds });
    return response.data.schedule || response.data;
  },
};

// =============================================================================
// SHIFTS SERVICE
// =============================================================================

export const shiftsService = {
  /**
   * Lists shifts with optional filters
   */
  async listShifts(filters?: {
    schedule_id?: string;
    employee_id?: string;
    station_id?: string;
    role_id?: string;
    shift_date?: string;
    status?: string;
  }) {
    const response = await schedulehubClient.listShifts(filters);
    return response.data.shifts || response.data;
  },

  /**
   * Gets a single shift by ID
   */
  async getShift(id: string): Promise<Shift> {
    const response = await schedulehubClient.getShift(id);
    return response.data.shift || response.data;
  },

  /**
   * Creates a new shift
   */
  async createShift(data: CreateShiftForm): Promise<Shift> {
    const response = await schedulehubClient.createShift(data);
    return response.data.shift || response.data;
  },

  /**
   * Updates an existing shift
   */
  async updateShift(id: string, updates: Partial<CreateShiftForm>): Promise<Shift> {
    const response = await schedulehubClient.updateShift(id, updates);
    return response.data.shift || response.data;
  },

  /**
   * Deletes a shift
   */
  async deleteShift(id: string) {
    await schedulehubClient.deleteShift(id);
  },

  /**
   * Assigns a worker to a shift
   */
  async assignWorkerToShift(shiftId: string, workerId: string): Promise<Shift> {
    const response = await schedulehubClient.assignWorkerToShift(shiftId, workerId);
    return response.data.shift || response.data;
  },

  /**
   * Clocks in for a shift
   */
  async clockIn(shiftId: string) {
    const response = await schedulehubClient.clockIn(shiftId);
    return response.data.shift || response.data;
  },

  /**
   * Clocks out from a shift
   */
  async clockOut(shiftId: string) {
    const response = await schedulehubClient.clockOut(shiftId);
    return response.data.shift || response.data;
  },
};

// =============================================================================
// WORKERS SERVICE
// =============================================================================

export const workersService = {
  /**
   * Lists all workers with optional filters
   */
  async listWorkers(filters?: {
    status?: 'active' | 'inactive' | 'terminated';
    department_id?: string;
    location_id?: string;
    search?: string;
  }) {
    const response = await schedulehubClient.listWorkers(filters);
    return response.data.workers || response.data;
  },

  /**
   * Gets a single worker by ID
   */
  async getWorker(id: string): Promise<Worker> {
    const response = await schedulehubClient.getWorker(id);
    return response.data.worker || response.data;
  },

  /**
   * Gets a worker with their assigned roles
   */
  async getWorkerWithRoles(id: string): Promise<WorkerWithRoles> {
    const response = await schedulehubClient.getWorkerWithRoles(id);
    return response.data.worker || response.data;
  },

  /**
   * Creates a new worker
   */
  async createWorker(data: CreateWorkerForm): Promise<Worker> {
    const response = await schedulehubClient.createWorker(data);
    return response.data.worker || response.data;
  },

  /**
   * Updates an existing worker
   */
  async updateWorker(id: string, updates: Partial<CreateWorkerForm>): Promise<Worker> {
    const response = await schedulehubClient.updateWorker(id, updates);
    return response.data.worker || response.data;
  },

  /**
   * Terminates a worker
   */
  async terminateWorker(id: string, terminationDate: string) {
    const response = await schedulehubClient.terminateWorker(id, { termination_date: terminationDate });
    return response.data.worker || response.data;
  },

  /**
   * Assigns roles to a worker
   */
  async assignRoles(workerId: string, roleIds: string[]) {
    const response = await schedulehubClient.assignWorkerRoles(workerId, { role_ids: roleIds });
    return response.data;
  },
};

// =============================================================================
// STATIONS SERVICE
// =============================================================================

export const stationsService = {
  /**
   * Lists all stations
   */
  async listStations(filters?: {
    location_id?: string;
    department_id?: string;
    is_active?: boolean;
  }) {
    const response = await schedulehubClient.listStations(filters);
    return response.data.stations || response.data;
  },

  /**
   * Gets a single station by ID
   */
  async getStation(id: string): Promise<Station> {
    const response = await schedulehubClient.getStation(id);
    return response.data.station || response.data;
  },

  /**
   * Creates a new station
   */
  async createStation(data: CreateStationForm): Promise<Station> {
    const response = await schedulehubClient.createStation(data);
    return response.data.station || response.data;
  },

  /**
   * Updates an existing station
   */
  async updateStation(id: string, updates: Partial<CreateStationForm>): Promise<Station> {
    const response = await schedulehubClient.updateStation(id, updates);
    return response.data.station || response.data;
  },

  /**
   * Deletes a station
   */
  async deleteStation(id: string) {
    await schedulehubClient.deleteStation(id);
  },

  /**
   * Gets station coverage analysis
   */
  async getStationCoverage(stationId: string, date: string) {
    const response = await schedulehubClient.getStationCoverage(stationId, date);
    return response.data;
  },
};

// =============================================================================
// ROLES SERVICE
// =============================================================================

export const rolesService = {
  /**
   * Lists all roles
   */
  async listRoles(filters?: { is_active?: boolean }) {
    const response = await schedulehubClient.listRoles(filters);
    return response.data.roles || response.data;
  },

  /**
   * Gets a single role by ID
   */
  async getRole(id: string): Promise<Role> {
    const response = await schedulehubClient.getRole(id);
    return response.data.role || response.data;
  },

  /**
   * Creates a new role
   */
  async createRole(data: CreateRoleForm): Promise<Role> {
    const response = await schedulehubClient.createRole(data);
    return response.data.role || response.data;
  },

  /**
   * Updates an existing role
   */
  async updateRole(id: string, updates: Partial<CreateRoleForm>): Promise<Role> {
    const response = await schedulehubClient.updateRole(id, updates);
    return response.data.role || response.data;
  },

  /**
   * Deletes a role
   */
  async deleteRole(id: string) {
    await schedulehubClient.deleteRole(id);
  },
};

// =============================================================================
// AVAILABILITY SERVICE
// =============================================================================

export const availabilityService = {
  /**
   * Lists availability records for a worker
   */
  async listAvailability(workerId: string) {
    const response = await schedulehubClient.listAvailability({ worker_id: workerId });
    return response.data.availability || response.data;
  },

  /**
   * Gets a single availability record
   */
  async getAvailability(id: string): Promise<Availability> {
    const response = await schedulehubClient.getAvailability(id);
    return response.data.availability || response.data;
  },

  /**
   * Creates a new availability record
   */
  async createAvailability(data: CreateAvailabilityForm): Promise<Availability> {
    const response = await schedulehubClient.createAvailability(data);
    return response.data.availability || response.data;
  },

  /**
   * Updates an existing availability record
   */
  async updateAvailability(id: string, updates: Partial<CreateAvailabilityForm>): Promise<Availability> {
    const response = await schedulehubClient.updateAvailability(id, updates);
    return response.data.availability || response.data;
  },

  /**
   * Deletes an availability record
   */
  async deleteAvailability(id: string) {
    await schedulehubClient.deleteAvailability(id);
  },
};

// =============================================================================
// TIME OFF SERVICE
// =============================================================================

export const timeOffService = {
  /**
   * Lists time off requests
   */
  async listTimeOffRequests(filters?: {
    worker_id?: string;
    status?: 'pending' | 'approved' | 'denied' | 'cancelled';
  }) {
    const response = await schedulehubClient.listTimeOffRequests(filters);
    return response.data.timeOffRequests || response.data;
  },

  /**
   * Gets a single time off request
   */
  async getTimeOffRequest(id: string): Promise<TimeOffRequest> {
    const response = await schedulehubClient.getTimeOffRequest(id);
    return response.data.timeOffRequest || response.data;
  },

  /**
   * Creates a new time off request
   */
  async createTimeOffRequest(data: CreateTimeOffRequestForm): Promise<TimeOffRequest> {
    const response = await schedulehubClient.createTimeOffRequest(data);
    return response.data.timeOffRequest || response.data;
  },

  /**
   * Approves a time off request
   */
  async approveTimeOffRequest(id: string, notes?: string) {
    const response = await schedulehubClient.approveTimeOffRequest(id, { review_notes: notes });
    return response.data.timeOffRequest || response.data;
  },

  /**
   * Denies a time off request
   */
  async denyTimeOffRequest(id: string, notes?: string) {
    const response = await schedulehubClient.denyTimeOffRequest(id, { review_notes: notes });
    return response.data.timeOffRequest || response.data;
  },
};

// =============================================================================
// SHIFT SWAPS SERVICE
// =============================================================================

export const shiftSwapsService = {
  /**
   * Lists shift swap offers (marketplace)
   */
  async listShiftSwaps(filters?: {
    status?: string;
    worker_id?: string;
  }) {
    const response = await schedulehubClient.listShiftSwaps(filters);
    return response.data.shiftSwaps || response.data;
  },

  /**
   * Gets a single shift swap offer
   */
  async getShiftSwap(id: string): Promise<ShiftSwapOffer> {
    const response = await schedulehubClient.getShiftSwap(id);
    return response.data.shiftSwap || response.data;
  },

  /**
   * Creates a new shift swap offer
   */
  async createShiftSwap(data: CreateSwapOfferForm): Promise<ShiftSwapOffer> {
    const response = await schedulehubClient.createShiftSwap(data);
    return response.data.shiftSwap || response.data;
  },

  /**
   * Requests to take a shift swap
   */
  async requestShiftSwap(offerId: string, notes?: string) {
    const response = await schedulehubClient.requestShiftSwap(offerId, { notes });
    return response.data;
  },

  /**
   * Approves a shift swap
   */
  async approveShiftSwap(id: string) {
    const response = await schedulehubClient.approveShiftSwap(id);
    return response.data;
  },

  /**
   * Cancels a shift swap offer
   */
  async cancelShiftSwap(id: string) {
    const response = await schedulehubClient.cancelShiftSwap(id);
    return response.data;
  },
};

// =============================================================================
// SHIFT TEMPLATES SERVICE
// =============================================================================

export const templatesService = {
  /**
   * Lists shift templates
   */
  async listTemplates(filters?: {
    is_active?: boolean;
    shift_type?: string;
  }) {
    const response = await schedulehubClient.listShiftTemplates(filters);
    return response.data.templates || response.data;
  },

  /**
   * Gets a single template by ID
   */
  async getTemplate(id: string): Promise<ShiftTemplate> {
    const response = await schedulehubClient.getShiftTemplate(id);
    return response.data.template || response.data;
  },

  /**
   * Gets template details with roles and stations
   */
  async getTemplateDetails(id: string): Promise<ShiftTemplateDetails> {
    const response = await schedulehubClient.getShiftTemplateDetails(id);
    return response.data.template || response.data;
  },

  /**
   * Creates a new shift template
   */
  async createTemplate(data: CreateShiftTemplateRequest): Promise<ShiftTemplate> {
    const response = await schedulehubClient.createShiftTemplate(data);
    return response.data.template || response.data;
  },

  /**
   * Updates an existing template
   */
  async updateTemplate(id: string, updates: UpdateShiftTemplateRequest): Promise<ShiftTemplate> {
    const response = await schedulehubClient.updateShiftTemplate(id, updates);
    return response.data.template || response.data;
  },

  /**
   * Deletes a template
   */
  async deleteTemplate(id: string) {
    await schedulehubClient.deleteShiftTemplate(id);
  },
};

// =============================================================================
// DASHBOARD SERVICE
// =============================================================================

export const dashboardService = {
  /**
   * Gets dashboard statistics
   */
  async getStats(): Promise<DashboardStats> {
    const response = await schedulehubClient.getDashboardStats();
    return response.data;
  },
};
